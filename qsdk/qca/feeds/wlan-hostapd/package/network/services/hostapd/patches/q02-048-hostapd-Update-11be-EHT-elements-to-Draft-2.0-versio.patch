From 7377742385c93887bc125cecc21204387112517d Mon Sep 17 00:00:00 2001
From: Balamurugan Mahalingam <quic_bmahalin@quicinc.com>
Date: Tue, 16 Aug 2022 17:53:38 -0700
Subject: [PATCH] hostapd: Update 11be EHT elements to Draft 2.0 version

Update the EHT operations elements to Draft 2.0 and fix interop
issues with stations

Signed-off-by: Balamurugan Mahalingam <quic_bmahalin@quicinc.com>
---
 hostapd/config_file.c        |  2 ++
 src/ap/ap_config.h           |  9 +++++++++
 src/ap/beacon.c              |  5 +++++
 src/ap/ctrl_iface_ap.c       |  6 ++++--
 src/ap/ieee802_11.c          |  2 ++
 src/ap/ieee802_11_eht.c      | 34 ++++++++++++++++++++++++++++------
 src/common/ieee802_11_defs.h | 35 +++++++++++++++++++++++------------
 wpa_supplicant/mesh_mpm.c    | 10 +++++-----
 8 files changed, 78 insertions(+), 25 deletions(-)

--- a/hostapd/config_file.c
+++ b/hostapd/config_file.c
@@ -4735,6 +4735,8 @@ static int hostapd_config_fill(struct ho
 		conf->eht_oper_chwidth = atoi(pos);
 	} else if (os_strcmp(buf, "eht_oper_centr_freq_seg0_idx") == 0) {
 		conf->eht_oper_centr_freq_seg0_idx = atoi(pos);
+	} else if (os_strcmp(buf, "eht_oper_centr_freq_seg1_idx") == 0) {
+		conf->eht_oper_centr_freq_seg1_idx = atoi(pos);
 	} else if (os_strcmp(buf, "eht_su_beamformer") == 0) {
 		conf->eht_phy_capab.su_beamformer = atoi(pos);
 	} else if (os_strcmp(buf, "eht_su_beamformee") == 0) {
--- a/src/ap/ap_config.h
+++ b/src/ap/ap_config.h
@@ -1172,6 +1172,7 @@ struct hostapd_config {
 #ifdef CONFIG_IEEE80211BE
 	enum oper_chan_width eht_oper_chwidth;
 	u8 eht_oper_centr_freq_seg0_idx;
+	u8 eht_oper_centr_freq_seg1_idx;
 	struct eht_phy_capabilities_info eht_phy_capab;
 #endif /* CONFIG_IEEE80211BE */
 
@@ -1261,6 +1262,10 @@ hostapd_set_oper_centr_freq_seg0_idx(str
 static inline u8
 hostapd_get_oper_centr_freq_seg1_idx(struct hostapd_config *conf)
 {
+#ifdef CONFIG_IEEE80211BE
+	if (conf->ieee80211be)
+		return conf->eht_oper_centr_freq_seg1_idx;
+#endif /* CONFIG_IEEE80211BE */
 #ifdef CONFIG_IEEE80211AX
 	if (conf->ieee80211ax)
 		return conf->he_oper_centr_freq_seg1_idx;
@@ -1272,6 +1277,10 @@ static inline void
 hostapd_set_oper_centr_freq_seg1_idx(struct hostapd_config *conf,
 				     u8 oper_centr_freq_seg1_idx)
 {
+#ifdef CONFIG_IEEE80211BE
+	if (conf->ieee80211be)
+		conf->eht_oper_centr_freq_seg1_idx = oper_centr_freq_seg1_idx;
+#endif /* CONFIG_IEEE80211BE */
 #ifdef CONFIG_IEEE80211AX
 	if (conf->ieee80211ax)
 		conf->he_oper_centr_freq_seg1_idx = oper_centr_freq_seg1_idx;
--- a/src/ap/beacon.c
+++ b/src/ap/beacon.c
@@ -609,6 +609,8 @@ static u8 * hostapd_gen_probe_resp(struc
 	if (hapd->iconf->ieee80211be && !hapd->conf->disable_11be) {
 		buflen += hostapd_eid_eht_capab_len(hapd, IEEE80211_MODE_AP);
 		buflen += 3 + sizeof(struct ieee80211_eht_operation);
+		if (hapd->iconf->ru_punct_bitmap)
+			buflen +=  DISABLED_SUBCHANNEL_BITMAP_BYTES_SIZE;
 	}
 #endif /* CONFIG_IEEE80211BE */
 
@@ -774,7 +776,7 @@ static u8 * hostapd_gen_probe_resp(struc
 #ifdef CONFIG_IEEE80211BE
 	if (hapd->iconf->ieee80211be && !hapd->conf->disable_11be) {
 		pos = hostapd_eid_eht_capab(hapd, pos, IEEE80211_MODE_AP);
-		pos = hostapd_eid_eht_operation(hapd, pos);
+		pos = hostapd_eid_eht_operation(hapd, pos, IEEE80211_MODE_AP);
 	}
 #endif /* CONFIG_IEEE80211BE */
 
@@ -1744,6 +1746,8 @@ int ieee802_11_build_ap_params(struct ho
 	if (hapd->iconf->ieee80211be && !hapd->conf->disable_11be) {
 		tail_len += hostapd_eid_eht_capab_len(hapd, IEEE80211_MODE_AP);
 		tail_len += 3 + sizeof(struct ieee80211_eht_operation);
+		if (hapd->iconf->ru_punct_bitmap)
+			tail_len +=  DISABLED_SUBCHANNEL_BITMAP_BYTES_SIZE;
 	}
 #endif /* CONFIG_IEEE80211BE */
 
@@ -1919,7 +1923,7 @@ int ieee802_11_build_ap_params(struct ho
 	if (hapd->iconf->ieee80211be && !hapd->conf->disable_11be) {
 		tailpos = hostapd_eid_eht_capab(hapd, tailpos,
 						IEEE80211_MODE_AP);
-		tailpos = hostapd_eid_eht_operation(hapd, tailpos);
+		tailpos = hostapd_eid_eht_operation(hapd, tailpos, IEEE80211_MODE_AP);
 	}
 #endif /* CONFIG_IEEE80211BE */
 
--- a/src/ap/ctrl_iface_ap.c
+++ b/src/ap/ctrl_iface_ap.c
@@ -959,9 +959,11 @@ int hostapd_ctrl_iface_status(struct hos
 	if (iface->conf->ieee80211be && !hapd->conf->disable_11be) {
 		ret = os_snprintf(buf + len, buflen - len,
 				  "eht_oper_chwidth=%d\n"
-				  "eht_oper_centr_freq_seg0_idx=%d\n",
+				  "eht_oper_centr_freq_seg0_idx=%d\n"
+				  "eht_oper_centr_freq_seg1_idx=%d\n",
 				  iface->conf->eht_oper_chwidth,
-				  iface->conf->eht_oper_centr_freq_seg0_idx);
+				  iface->conf->eht_oper_centr_freq_seg0_idx,
+				  iface->conf->eht_oper_centr_freq_seg1_idx);
 		if (os_snprintf_error(buflen - len, ret))
 			return len;
 		len += ret;
--- a/src/ap/ieee802_11.c
+++ b/src/ap/ieee802_11.c
@@ -4284,6 +4284,8 @@ static u16 send_assoc_resp(struct hostap
 	if (hapd->iconf->ieee80211be && !hapd->conf->disable_11be) {
 		buflen += hostapd_eid_eht_capab_len(hapd, IEEE80211_MODE_AP);
 		buflen += 3 + sizeof(struct ieee80211_eht_operation);
+		if (hapd->iconf->ru_punct_bitmap)
+			buflen +=  DISABLED_SUBCHANNEL_BITMAP_BYTES_SIZE;
 	}
 #endif /* CONFIG_IEEE80211BE */
 
@@ -4436,7 +4438,7 @@ rsnxe_done:
 #ifdef CONFIG_IEEE80211BE
 	if (hapd->iconf->ieee80211be && !hapd->conf->disable_11be) {
 		p = hostapd_eid_eht_capab(hapd, p, IEEE80211_MODE_AP);
-		p = hostapd_eid_eht_operation(hapd, p);
+		p = hostapd_eid_eht_operation(hapd, p, IEEE80211_MODE_AP);
 	}
 #endif /* CONFIG_IEEE80211BE */
 
--- a/src/ap/ieee802_11_eht.c
+++ b/src/ap/ieee802_11_eht.c
@@ -207,29 +207,28 @@ u8 * hostapd_eid_eht_capab(struct hostap
 }
 
 
-u8 * hostapd_eid_eht_operation(struct hostapd_data *hapd, u8 *eid)
+u8 * hostapd_eid_eht_operation(struct hostapd_data *hapd, u8 *eid,
+			       enum ieee80211_op_mode opmode)
 {
 	struct hostapd_config *conf = hapd->iconf;
 	struct ieee80211_eht_operation *oper;
-	u8 *pos = eid, seg0 = 0, seg1 = 0;
+	u8 *pos = eid, seg0 = 0, seg1 = 0, *length_pos;
+	struct eht_capabilities *eht_cap;
 	enum oper_chan_width chwidth;
-	size_t elen = 1 + 4 + 3;
 
 	if (!hapd->iface->current_mode)
 		return eid;
 
 	*pos++ = WLAN_EID_EXTENSION;
-	*pos++ = 1 + elen;
+	length_pos = pos++;
 	*pos++ = WLAN_EID_EXT_EHT_OPERATION;
 
 	oper = (struct ieee80211_eht_operation *) pos;
 	oper->oper_params = EHT_OPER_INFO_PRESENT;
 
-	/* TODO: Fill in appropriate EHT-MCS max Nss information */
-	oper->basic_eht_mcs_nss_set[0] = 0x11;
-	oper->basic_eht_mcs_nss_set[1] = 0x00;
-	oper->basic_eht_mcs_nss_set[2] = 0x00;
-	oper->basic_eht_mcs_nss_set[3] = 0x00;
+	eht_cap = &hapd->iface->current_mode->eht_capab[opmode];
+	memcpy(&oper->basic_mcs_nss, &eht_cap->mcs,
+	       EHT_PHYCAP_MCS_NSS_LEN_20MHZ_ONLY);
 
 	if (is_6ghz_op_class(conf->op_class))
 		chwidth = op_class_to_ch_width(conf->op_class);
@@ -257,6 +256,15 @@ u8 * hostapd_eid_eht_operation(struct ho
 		break;
 	case CONF_OPER_CHWIDTH_160MHZ:
 		oper->oper_info.control |= EHT_OPER_CHANNEL_WIDTH_160MHZ;
+		if (!oper->oper_info.ccfs1) {
+			/* CCFS0 points to center channel frequency in config */
+			oper->oper_info.ccfs1 = oper->oper_info.ccfs0;
+			if (hapd->iconf->channel < oper->oper_info.ccfs0)
+				oper->oper_info.ccfs0 = oper->oper_info.ccfs1 - 8;
+			else
+				oper->oper_info.ccfs0 = oper->oper_info.ccfs1 + 8;
+		}
+
 		if (hapd->iconf->ru_punct_bitmap &&
 		    hapd->iface->ru_punct_supp_bw == CONF_OPER_CHWIDTH_320MHZ) {
 			hapd->iconf->ru_punct_bitmap = 0;
@@ -296,7 +304,9 @@ u8 * hostapd_eid_eht_operation(struct ho
 		oper->oper_info.disabled_chan_bitmap = host_to_le16(hapd->iconf->ru_punct_bitmap);
 	}
 
-	return pos + elen;
+	pos += 8;
+	*length_pos = pos - (eid + 2);
+	return pos;
 }
 
 
--- a/src/common/ieee802_11_defs.h
+++ b/src/common/ieee802_11_defs.h
@@ -2501,6 +2501,9 @@ struct ieee80211_he_mu_edca_parameter_se
 #define EHT_OPER_CHANNEL_WIDTH_160MHZ                  3
 #define EHT_OPER_CHANNEL_WIDTH_320MHZ                  4
 
+#define DISABLED_SUBCHANNEL_BITMAP_BYTES_SIZE          2
+
+
 /* Figure 9-1002c: EHT Operation Information field format */
 struct ieee80211_eht_oper_info {
 	u8 control; /* B0..B2: Channel Width */
@@ -2512,7 +2515,7 @@ struct ieee80211_eht_oper_info {
 /* Figure 9-1002a: EHT Operation element format */
 struct ieee80211_eht_operation {
 	u8 oper_params; /* EHT Operation Parameters: EHT_OPER_* bits */
-	u8 basic_eht_mcs_nss_set[4];
+	le32 basic_mcs_nss;
 	struct ieee80211_eht_oper_info oper_info; /* 0 or 3 or 5 octets */
 } STRUCT_PACKED;
 
--- a/src/ap/ieee802_11.h
+++ b/src/ap/ieee802_11.h
@@ -218,7 +218,8 @@ size_t hostapd_eid_eht_capab_len(struct
 				 enum ieee80211_op_mode opmode);
 u8 * hostapd_eid_eht_capab(struct hostapd_data *hapd, u8 *eid,
 			   enum ieee80211_op_mode opmode);
-u8 * hostapd_eid_eht_operation(struct hostapd_data *hapd, u8 *eid);
+u8 * hostapd_eid_eht_operation(struct hostapd_data *hapd, u8 *eid,
+			       enum ieee80211_op_mode opmode);
 u16 copy_sta_eht_capab(struct hostapd_data *hapd, struct sta_info *sta,
 		       enum ieee80211_op_mode opmode,
 		       const u8 *he_capab, size_t he_capab_len,
--- a/wpa_supplicant/mesh_mpm.c
+++ b/wpa_supplicant/mesh_mpm.c
@@ -265,6 +265,8 @@ static void mesh_mpm_send_plink_action(s
 			   EHT_MCS_NSS_CAPAB_LEN +
 			   EHT_PPE_THRESH_CAPAB_LEN;
 		buf_len += 3 + sizeof(struct ieee80211_eht_operation);
+		if (bss->iconf->ru_punct_bitmap)
+			buf_len +=  DISABLED_SUBCHANNEL_BITMAP_BYTES_SIZE;
 	}
 #endif /* CONFIG_IEEE80211BE */
 	if (type != PLINK_CLOSE)
